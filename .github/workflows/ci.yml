name: CI
on: [push]
jobs:
  Test1:
    runs-on: ubuntu-latest
    env: 
      KUBECONFIG: fauxpenshift.kubeconfig
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: List files in the directory
        run: |
          ls ${{ github.workplace }}
      - name: Print CWD
        run: echo "$PWD"
      - name: Configure env
        run: |
          sudo apt-get update
          sudo apt-get install \
              ca-certificates \
              curl \
              wget \
              gnupg \
              lsb-release
          sudo mkdir -m 0755 -p /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo chmod a+r /etc/apt/keyrings/docker.gpg
          sudo apt-get update
      - name: Install Docker
        run: |
          sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      - name: Check docker is running
        run: |
          sudo systemctl status docker
      - name: Get Docker info
        run: |
          docker info
      - name: Get OC CLI Binary
        run: |
          wget https://github.com/okd-project/okd/releases/download/4.12.0-0.okd-2023-02-18-033438/openshift-client-linux-4.12.0-0.okd-2023-02-18-033438.tar.gz
          tar xzvf openshift-client-linux-4.12.0-0.okd-2023-02-18-033438.tar.gz
          sudo mv oc kubectl /usr/local/bin
      - name: Run OC Binary
        run: oc --help
      - name: Get CLI
        run: |
          sudo wget -O /usr/local/bin/fauxpenshift https://github.com/christianh814/fauxpenshift/releases/download/v0.0.10/fauxpenshift-linux-amd64
      - name: Make it executable
        run: |
          sudo chmod +x /usr/local/bin/fauxpenshift
      - name: Create Microshift Instance
        run: |
          sudo FAUXPENSHIFT_RUNTIME=docker fauxpenshift create
      - name: Check the Microshift Instance
        run: |
          sudo FAUXPENSHIFT_RUNTIME=docker fauxpenshift list
      - name: Export the kubeconfig
        run: sudo FAUXPENSHIFT_RUNTIME=docker fauxpenshift kubeconfig > tests/fauxpenshift.kubeconfig
      - name: List the kubeconfig file
        run: ls tests
      - name: Run launch script
        run: |
          cd tests
          oc create -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/bundle.yaml
          sleep 10s
          ./launch.sh deploy
      - name: Sleep for 120
        run: sleep 120s
      - name: Get the pod status
        run: |
          cd tests
          oc get pods -n minio ; oc get pods -n observatorium ; oc get pods -n observatorium-metrics ; oc get pods -n dex ; oc get pods -n telemeter
          ./ci-check.sh
