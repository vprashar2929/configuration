---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: observatorium-thanos-stage
spec:
  groups:
  - name: thanos-component-absent
    rules:
    - alert: ThanosCompactIsDown
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-component-absent?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: ThanosCompact has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        message: ThanosCompact has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanoscompactisdown
        summary: Thanos component has disappeared from {{$labels.namespace}}.
      expr: |
        absent(up{job="observatorium-thanos-compact"} == 1)
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosQueryIsDown
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-component-absent?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: ThanosQuery has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        message: ThanosQuery has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosqueryisdown
        summary: Thanos component has disappeared from {{$labels.namespace}}.
      expr: |
        absent(up{job="observatorium-thanos-query"} == 1)
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosReceiveIsDown
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-component-absent?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: ThanosReceive has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        message: ThanosReceive has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceiveisdown
        summary: Thanos component has disappeared from {{$labels.namespace}}.
      expr: |
        absent(up{job=~"observatorium-thanos-receive-default.*"} == 1)
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosRuleIsDown
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-component-absent?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: ThanosRule has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        message: ThanosRule has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosruleisdown
        summary: Thanos component has disappeared from {{$labels.namespace}}.
      expr: |
        absent(up{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"} == 1)
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosStoreIsDown
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-component-absent?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: ThanosStore has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        message: ThanosStore has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosstoreisdown
        summary: Thanos component has disappeared from {{$labels.namespace}}.
      expr: |
        absent(up{job=~"observatorium-thanos-store-shard.*"} == 1)
      for: 5m
      labels:
        service: telemeter
        severity: high
  - name: thanos-compact
    rules:
    - alert: ThanosCompactMultipleRunning
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/651943d05a8123e32867b4673963f42b/thanos-compact?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: No more than one Thanos Compact instance should be running at once. There are {{$value}} in {{$labels.namespace}} instances running.
        message: No more than one Thanos Compact instance should be running at once. There are {{$value}} in {{$labels.namespace}} instances running.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanoscompactmultiplerunning
        summary: Thanos Compact has multiple instances running.
      expr: sum by (namespace, job) (up{job="observatorium-thanos-compact"}) > 1
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosCompactHalted
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/651943d05a8123e32867b4673963f42b/thanos-compact?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Compact {{$labels.job}} in {{$labels.namespace}} has failed to run and now is halted.
        message: Thanos Compact {{$labels.job}} in {{$labels.namespace}} has failed to run and now is halted.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanoscompacthalted
        summary: Thanos Compact has failed to run and is now halted.
      expr: thanos_compact_halted{job="observatorium-thanos-compact"} == 1
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosCompactHighCompactionFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/651943d05a8123e32867b4673963f42b/thanos-compact?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Compact {{$labels.job}} in {{$labels.namespace}} is failing to execute {{$value | humanize}}% of compactions.
        message: Thanos Compact {{$labels.job}} in {{$labels.namespace}} is failing to execute {{$value | humanize}}% of compactions.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanoscompacthighcompactionfailures
        summary: Thanos Compact is failing to execute compactions.
      expr: |
        (
          sum by (namespace, job) (rate(thanos_compact_group_compactions_failures_total{job="observatorium-thanos-compact"}[5m]))
        /
          sum by (namespace, job) (rate(thanos_compact_group_compactions_total{job="observatorium-thanos-compact"}[5m]))
        * 100 > 5
        )
      for: 15m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosCompactBucketHighOperationFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/651943d05a8123e32867b4673963f42b/thanos-compact?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Compact {{$labels.job}} in {{$labels.namespace}} Bucket is failing to execute {{$value | humanize}}% of operations.
        message: Thanos Compact {{$labels.job}} in {{$labels.namespace}} Bucket is failing to execute {{$value | humanize}}% of operations.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanoscompactbuckethighoperationfailures
        summary: Thanos Compact Bucket is having a high number of operation failures.
      expr: |
        (
          sum by (namespace, job) (rate(thanos_objstore_bucket_operation_failures_total{job="observatorium-thanos-compact"}[5m]))
        /
          sum by (namespace, job) (rate(thanos_objstore_bucket_operations_total{job="observatorium-thanos-compact"}[5m]))
        * 100 > 5
        )
      for: 15m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosCompactHasNotRun
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/651943d05a8123e32867b4673963f42b/thanos-compact?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Compact {{$labels.job}} in {{$labels.namespace}} has not uploaded anything for 24 hours.
        message: Thanos Compact {{$labels.job}} in {{$labels.namespace}} has not uploaded anything for 24 hours.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanoscompacthasnotrun
        summary: Thanos Compact has not uploaded anything for last 24 hours.
      expr: (time() - max by (namespace, job) (max_over_time(thanos_objstore_bucket_last_successful_upload_time{job="observatorium-thanos-compact"}[24h]))) / 60 / 60 > 24
      labels:
        service: telemeter
        severity: medium
  - name: thanos-query
    rules:
    - alert: ThanosQueryHttpRequestQueryErrorRateHigh
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/98fde97ddeaf2981041745f1f2ba68c2/thanos-query?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Query {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of "query" requests.
        message: Thanos Query {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of "query" requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosqueryhttprequestqueryerrorratehigh
        summary: Thanos Query is failing to handle requests.
      expr: |
        (
          sum by (namespace, job) (rate(http_requests_total{code=~"5..", job="observatorium-thanos-query", handler="query"}[5m]))
        /
          sum by (namespace, job) (rate(http_requests_total{job="observatorium-thanos-query", handler="query"}[5m]))
        ) * 100 > 5
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosQueryGrpcServerErrorRate
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/98fde97ddeaf2981041745f1f2ba68c2/thanos-query?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Query {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of requests.
        message: Thanos Query {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosquerygrpcservererrorrate
        summary: Thanos Query is failing to handle requests.
      expr: |
        (
          sum by (namespace, job) (rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss|DeadlineExceeded", job="observatorium-thanos-query"}[5m]))
        /
          sum by (namespace, job) (rate(grpc_server_started_total{job="observatorium-thanos-query"}[5m]))
        * 100 > 5
        )
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosQueryGrpcClientErrorRate
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/98fde97ddeaf2981041745f1f2ba68c2/thanos-query?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Query {{$labels.job}} in {{$labels.namespace}} is failing to send {{$value | humanize}}% of requests.
        message: Thanos Query {{$labels.job}} in {{$labels.namespace}} is failing to send {{$value | humanize}}% of requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosquerygrpcclienterrorrate
        summary: Thanos Query is failing to send requests.
      expr: |
        (
          sum by (namespace, job) (rate(grpc_client_handled_total{grpc_code!="OK", job="observatorium-thanos-query"}[5m]))
        /
          sum by (namespace, job) (rate(grpc_client_started_total{job="observatorium-thanos-query"}[5m]))
        ) * 100 > 5
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosQueryHighDNSFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/98fde97ddeaf2981041745f1f2ba68c2/thanos-query?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Query {{$labels.job}} in {{$labels.namespace}} have {{$value | humanize}}% of failing DNS queries for store endpoints.
        message: Thanos Query {{$labels.job}} in {{$labels.namespace}} have {{$value | humanize}}% of failing DNS queries for store endpoints.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosqueryhighdnsfailures
        summary: Thanos Query is having high number of DNS failures.
      expr: |
        (
          sum by (namespace, job) (rate(thanos_query_store_apis_dns_failures_total{job="observatorium-thanos-query"}[5m]))
        /
          sum by (namespace, job) (rate(thanos_query_store_apis_dns_lookups_total{job="observatorium-thanos-query"}[5m]))
        ) * 100 > 1
      for: 15m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosQueryInstantLatencyHigh
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/98fde97ddeaf2981041745f1f2ba68c2/thanos-query?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Query {{$labels.job}} in {{$labels.namespace}} has a 99th percentile latency of {{$value}} seconds for instant queries.
        message: Thanos Query {{$labels.job}} in {{$labels.namespace}} has a 99th percentile latency of {{$value}} seconds for instant queries.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosqueryinstantlatencyhigh
        summary: Thanos Query has high latency for queries.
      expr: |
        (
          histogram_quantile(0.99, sum by (namespace, job, le) (rate(http_request_duration_seconds_bucket{job="observatorium-thanos-query", handler="query"}[5m]))) > 90
        and
          sum by (namespace, job) (rate(http_request_duration_seconds_bucket{job="observatorium-thanos-query", handler="query"}[5m])) > 0
        )
      for: 10m
      labels:
        service: telemeter
        severity: high
  - name: thanos-receive
    rules:
    - alert: ThanosReceiveHttpRequestErrorRateHigh
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/916a852b00ccc5ed81056644718fa4fb/thanos-receive?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Receive {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of requests.
        message: Thanos Receive {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivehttprequesterrorratehigh
        summary: Thanos Receive is failing to handle requests.
      expr: |
        (
          sum by (namespace, job) (rate(http_requests_total{code=~"5..", job=~"observatorium-thanos-receive-default.*", handler="receive"}[5m]))
        /
          sum by (namespace, job) (rate(http_requests_total{job=~"observatorium-thanos-receive-default.*", handler="receive"}[5m]))
        ) * 100 > 5
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosReceiveHttpRequestLatencyHigh
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/916a852b00ccc5ed81056644718fa4fb/thanos-receive?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Receive {{$labels.job}} in {{$labels.namespace}} has a 99th percentile latency of {{ $value }} seconds for requests.
        message: Thanos Receive {{$labels.job}} in {{$labels.namespace}} has a 99th percentile latency of {{ $value }} seconds for requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivehttprequestlatencyhigh
        summary: Thanos Receive has high HTTP requests latency.
      expr: |
        (
          histogram_quantile(0.99, sum by (namespace, job, le) (rate(http_request_duration_seconds_bucket{job=~"observatorium-thanos-receive-default.*", handler="receive"}[5m]))) > 10
        and
          sum by (namespace, job) (rate(http_request_duration_seconds_count{job=~"observatorium-thanos-receive-default.*", handler="receive"}[5m])) > 0
        )
      for: 10m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosReceiveHighReplicationFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/916a852b00ccc5ed81056644718fa4fb/thanos-receive?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Receive {{$labels.job}} in {{$labels.namespace}} is failing to replicate {{$value | humanize}}% of requests.
        message: Thanos Receive {{$labels.job}} in {{$labels.namespace}} is failing to replicate {{$value | humanize}}% of requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivehighreplicationfailures
        summary: Thanos Receive is having high number of replication failures.
      expr: |
        thanos_receive_replication_factor > 1
          and
        (
          (
            sum by (namespace, job) (rate(thanos_receive_replications_total{result="error", job=~"observatorium-thanos-receive-default.*"}[5m]))
          /
            sum by (namespace, job) (rate(thanos_receive_replications_total{job=~"observatorium-thanos-receive-default.*"}[5m]))
          )
          >
          (
            max by (namespace, job) (floor((thanos_receive_replication_factor{job=~"observatorium-thanos-receive-default.*"}+1) / 2))
          /
            max by (namespace, job) (thanos_receive_hashring_nodes{job=~"observatorium-thanos-receive-default.*"})
          )
        ) * 100
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosReceiveHighForwardRequestFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/916a852b00ccc5ed81056644718fa4fb/thanos-receive?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Receive {{$labels.job}} in {{$labels.namespace}} is failing to forward {{$value | humanize}}% of requests.
        message: Thanos Receive {{$labels.job}} in {{$labels.namespace}} is failing to forward {{$value | humanize}}% of requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivehighforwardrequestfailures
        summary: Thanos Receive is failing to forward requests.
      expr: |
        (
          sum by (namespace, job) (rate(thanos_receive_forward_requests_total{result="error", job=~"observatorium-thanos-receive-default.*"}[5m]))
        /
          sum by (namespace, job) (rate(thanos_receive_forward_requests_total{job=~"observatorium-thanos-receive-default.*"}[5m]))
        ) * 100 > 20
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosReceiveHighHashringFileRefreshFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/916a852b00ccc5ed81056644718fa4fb/thanos-receive?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Receive {{$labels.job}} in {{$labels.namespace}} is failing to refresh hashring file, {{$value | humanize}} of attempts failed.
        message: Thanos Receive {{$labels.job}} in {{$labels.namespace}} is failing to refresh hashring file, {{$value | humanize}} of attempts failed.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivehighhashringfilerefreshfailures
        summary: Thanos Receive is failing to refresh hasring file.
      expr: |
        (
          sum by (namespace, job) (rate(thanos_receive_hashrings_file_errors_total{job=~"observatorium-thanos-receive-default.*"}[5m]))
        /
          sum by (namespace, job) (rate(thanos_receive_hashrings_file_refreshes_total{job=~"observatorium-thanos-receive-default.*"}[5m]))
        > 0
        )
      for: 15m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosReceiveConfigReloadFailure
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/916a852b00ccc5ed81056644718fa4fb/thanos-receive?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Receive {{$labels.job}} in {{$labels.namespace}} has not been able to reload hashring configurations.
        message: Thanos Receive {{$labels.job}} in {{$labels.namespace}} has not been able to reload hashring configurations.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceiveconfigreloadfailure
        summary: Thanos Receive has not been able to reload configuration.
      expr: avg by (namespace, job) (thanos_receive_config_last_reload_successful{job=~"observatorium-thanos-receive-default.*"}) != 1
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosReceiveNoUpload
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/916a852b00ccc5ed81056644718fa4fb/thanos-receive?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Receive {{$labels.instance}} in {{$labels.namespace}} has not uploaded latest data to object storage.
        message: Thanos Receive {{$labels.instance}} in {{$labels.namespace}} has not uploaded latest data to object storage.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivenoupload
        summary: Thanos Receive has not uploaded latest data to object storage.
      expr: |
        (up{job=~"observatorium-thanos-receive-default.*"} - 1)
        + on (namespace, job, instance) # filters to only alert on current instance last 3h
        (sum by (namespace, job, instance) (increase(thanos_shipper_uploads_total{job=~"observatorium-thanos-receive-default.*"}[3h])) == 0)
      for: 3h
      labels:
        service: telemeter
        severity: high
  - name: thanos-store
    rules:
    - alert: ThanosStoreGrpcErrorRate
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/e832e8f26403d95fac0ea1c59837588b/thanos-store?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Store {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of requests.
        message: Thanos Store {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosstoregrpcerrorrate
        summary: Thanos Store is failing to handle qrpcd requests.
      expr: |
        (
          sum by (namespace, job) (rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss|DeadlineExceeded", job=~"observatorium-thanos-store-shard.*"}[5m]))
        /
          sum by (namespace, job) (rate(grpc_server_started_total{job=~"observatorium-thanos-store-shard.*"}[5m]))
        * 100 > 5
        )
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosStoreBucketHighOperationFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/e832e8f26403d95fac0ea1c59837588b/thanos-store?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Store {{$labels.job}} in {{$labels.namespace}} Bucket is failing to execute {{$value | humanize}}% of operations.
        message: Thanos Store {{$labels.job}} in {{$labels.namespace}} Bucket is failing to execute {{$value | humanize}}% of operations.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosstorebuckethighoperationfailures
        summary: Thanos Store Bucket is failing to execute operations.
      expr: |
        (
          sum by (namespace, job) (rate(thanos_objstore_bucket_operation_failures_total{job=~"observatorium-thanos-store-shard.*"}[5m]))
        /
          sum by (namespace, job) (rate(thanos_objstore_bucket_operations_total{job=~"observatorium-thanos-store-shard.*"}[5m]))
        * 100 > 5
        )
      for: 15m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosStoreObjstoreOperationLatencyHigh
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/e832e8f26403d95fac0ea1c59837588b/thanos-store?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Store {{$labels.job}} in {{$labels.namespace}} Bucket has a 99th percentile latency of {{$value}} seconds for the bucket operations.
        message: Thanos Store {{$labels.job}} in {{$labels.namespace}} Bucket has a 99th percentile latency of {{$value}} seconds for the bucket operations.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosstoreobjstoreoperationlatencyhigh
        summary: Thanos Store is having high latency for bucket operations.
      expr: |
        (
          histogram_quantile(0.99, sum by (namespace, job, le) (rate(thanos_objstore_bucket_operation_duration_seconds_bucket{job=~"observatorium-thanos-store-shard.*"}[5m]))) > 7
        and
          sum by (namespace, job) (rate(thanos_objstore_bucket_operation_duration_seconds_count{job=~"observatorium-thanos-store-shard.*"}[5m])) > 0
        )
      for: 10m
      labels:
        service: telemeter
        severity: medium
  - name: thanos-rule
    rules:
    - alert: ThanosRuleQueueIsDroppingAlerts
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} is failing to queue alerts.
        message: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} is failing to queue alerts.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosrulequeueisdroppingalerts
        summary: Thanos Rule is failing to queue alerts.
      expr: |
        sum by (namespace, job, instance) (rate(thanos_alert_queue_alerts_dropped_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m])) > 0
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosRuleSenderIsFailingAlerts
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} is failing to send alerts to alertmanager.
        message: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} is failing to send alerts to alertmanager.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosrulesenderisfailingalerts
        summary: Thanos Rule is failing to send alerts to alertmanager.
      expr: |
        sum by (namespace, job, instance) (rate(thanos_alert_sender_alerts_dropped_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m])) > 0
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosRuleHighRuleEvaluationFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} is failing to evaluate rules.
        message: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} is failing to evaluate rules.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosrulehighruleevaluationfailures
        summary: Thanos Rule is failing to evaluate rules.
      expr: |
        (
          sum by (namespace, job, instance) (rate(prometheus_rule_evaluation_failures_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m]))
        /
          sum by (namespace, job, instance) (rate(prometheus_rule_evaluations_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m]))
        * 100 > 5
        )
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosRuleHighRuleEvaluationWarnings
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} has high number of evaluation warnings.
        message: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} has high number of evaluation warnings.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosrulehighruleevaluationwarnings
        summary: Thanos Rule has high number of evaluation warnings.
      expr: |
        sum by (namespace, job, instance) (rate(thanos_rule_evaluation_with_warnings_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m])) > 0
      for: 15m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosRuleRuleEvaluationLatencyHigh
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} has higher evaluation latency than interval for {{$labels.rule_group}}.
        message: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} has higher evaluation latency than interval for {{$labels.rule_group}}.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosruleruleevaluationlatencyhigh
        summary: Thanos Rule has high rule evaluation latency.
      expr: |
        (
          sum by (namespace, job, instance, rule_group) (prometheus_rule_group_last_duration_seconds{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"})
        >
          sum by (namespace, job, instance, rule_group) (prometheus_rule_group_interval_seconds{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"})
        )
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosRuleGrpcErrorRate
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of requests.
        message: Thanos Rule {{$labels.job}} in {{$labels.namespace}} is failing to handle {{$value | humanize}}% of requests.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosrulegrpcerrorrate
        summary: Thanos Rule is failing to handle grpc requests.
      expr: |
        (
          sum by (namespace, job, instance) (rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss|DeadlineExceeded", job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m]))
        /
          sum by (namespace, job, instance) (rate(grpc_server_started_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m]))
        * 100 > 5
        )
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosRuleConfigReloadFailure
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.job}} in {{$labels.namespace}} has not been able to reload its configuration.
        message: Thanos Rule {{$labels.job}} in {{$labels.namespace}} has not been able to reload its configuration.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosruleconfigreloadfailure
        summary: Thanos Rule has not been able to reload configuration.
      expr: avg by (namespace, job, instance) (thanos_rule_config_last_reload_successful{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}) != 1
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosRuleQueryHighDNSFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.job}} in {{$labels.namespace}} has {{$value | humanize}}% of failing DNS queries for query endpoints.
        message: Thanos Rule {{$labels.job}} in {{$labels.namespace}} has {{$value | humanize}}% of failing DNS queries for query endpoints.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosrulequeryhighdnsfailures
        summary: Thanos Rule is having high number of DNS failures.
      expr: |
        (
          sum by (namespace, job, instance) (rate(thanos_rule_query_apis_dns_failures_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m]))
        /
          sum by (namespace, job, instance) (rate(thanos_rule_query_apis_dns_lookups_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m]))
        * 100 > 1
        )
      for: 15m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosRuleAlertmanagerHighDNSFailures
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} has {{$value | humanize}}% of failing DNS queries for Alertmanager endpoints.
        message: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} has {{$value | humanize}}% of failing DNS queries for Alertmanager endpoints.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosrulealertmanagerhighdnsfailures
        summary: Thanos Rule is having high number of DNS failures.
      expr: |
        (
          sum by (namespace, job, instance) (rate(thanos_rule_alertmanagers_dns_failures_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m]))
        /
          sum by (namespace, job, instance) (rate(thanos_rule_alertmanagers_dns_lookups_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m]))
        * 100 > 1
        )
      for: 15m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosRuleNoEvaluationFor10Intervals
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.job}} in {{$labels.namespace}} has rule groups that did not evaluate for at least 10x of their expected interval.
        message: Thanos Rule {{$labels.job}} in {{$labels.namespace}} has rule groups that did not evaluate for at least 10x of their expected interval.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosrulenoevaluationfor10intervals
        summary: Thanos Rule has rule groups that did not evaluate for 10 intervals.
      expr: |
        time() -  max by (namespace, job, instance, group) (prometheus_rule_group_last_evaluation_timestamp_seconds{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"})
        >
        10 * max by (namespace, job, instance, group) (prometheus_rule_group_interval_seconds{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"})
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosNoRuleEvaluations
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/35da848f5f92b2dc612e0c3a0577b8a1/thanos-rule?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        description: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} did not perform any rule evaluations in the past 10 minutes.
        message: Thanos Rule {{$labels.instance}} in {{$labels.namespace}} did not perform any rule evaluations in the past 10 minutes.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosnoruleevaluations
        summary: Thanos Rule did not perform any rule evaluations.
      expr: |
        sum by (namespace, job, instance) (rate(prometheus_rule_evaluations_total{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}[5m])) <= 0
          and
        sum by (namespace, job, instance) (thanos_rule_loaded_rules{job=~"observatorium-thanos-rule.*|observatorium-thanos-stateless-rule.*|observatorium-thanos-metric-federation-rule.*|observatorium-thanos-metric-fed-stateless-rule.*"}) > 0
      for: 5m
      labels:
        service: telemeter
        severity: high
  - name: thanos-receive-controller
    rules:
    - alert: ThanosReceiveControllerIsDown
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-receive-controller?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        message: Thanos Receive Controller has disappeared from {{$labels.namespace}}. Prometheus target for the component cannot be discovered.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivecontrollerisdown
      expr: |
        absent(up{job="observatorium-thanos-receive-controller"} == 1)
      for: 5m
      labels:
        service: telemeter
        severity: high
    - alert: ThanosReceiveControllerReconcileErrorRate
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-receive-controller?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        message: Thanos Receive Controller from {{$labels.namespace}} is failing to reconcile changes, {{ $value | humanize }}% of attempts failed.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivecontrollerreconcileerrorrate
      expr: |
        (
          sum by (namespace, job) (rate(thanos_receive_controller_reconcile_errors_total{job="observatorium-thanos-receive-controller"}[5m]))
        /
          sum by (namespace, job) (rate(thanos_receive_controller_reconcile_attempts_total{job="observatorium-thanos-receive-controller"}[5m]))
        ) * 100 >= 10
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosReceiveControllerConfigmapChangeErrorRate
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-receive-controller?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        message: Thanos Receive Controller from {{$labels.namespace}} is failing to refresh configmap, {{ $value | humanize }}% of attempts failed.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceivecontrollerconfigmapchangeerrorrate
      expr: |
        (
          sum by (namespace, job) (rate(thanos_receive_controller_configmap_change_errors_total{job="observatorium-thanos-receive-controller"}[5m]))
        /
          sum by (namespace, job) (rate(thanos_receive_controller_configmap_change_attempts_total{job="observatorium-thanos-receive-controller"}[5m]))
        ) * 100 >= 10
      for: 5m
      labels:
        service: telemeter
        severity: medium
    - alert: ThanosReceiveConfigInconsistent
      annotations:
        dashboard: https://grafana.app-sre.devshift.net/d/no-dashboard/thanos-receive-controller?orgId=1&refresh=10s&var-datasource=app-sre-stage-01-prometheus&var-namespace={{$labels.namespace}}&var-job=All&var-pod=All&var-interval=5m
        message: The configuration of the instances of Thanos Receive `{{$labels.job}}` from {{$labels.namespace}} are out of sync.
        runbook: https://github.com/rhobs/configuration/blob/main/docs/sop/observatorium.md#thanosreceiveconfiginconsistent
      expr: |
        (
          avg by (namespace, job) (thanos_receive_config_hash{job=~"observatorium-thanos-receive-default.*"})
        / on (namespace) group_left
          thanos_receive_controller_configmap_hash{job="observatorium-thanos-receive-controller"} != 1
        )
      for: 5m
      labels:
        service: telemeter
        severity: high
